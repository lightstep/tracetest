
<!DOCTYPE html>

<html class="no-js" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<meta content="Tracetest - Trace based testing.  Leverage your investment in tracing to easily create integration tests." name="description"/>
<meta content="Kubeshop Tracetest Team" name="author"/>
<link href="../assets/images/favicon.png" rel="icon"/>
<meta content="mkdocs-1.3.0, mkdocs-material-8.2.14" name="generator"/>
<title>Selectors - Tracetest</title>
<link href="../assets/stylesheets/main.3de6f41f.min.css" rel="stylesheet"/>
<link href="../assets/stylesheets/palette.cc9b2e1e.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<link href="../css/extra.css" rel="stylesheet"/>
<script>__md_scope=new URL("..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-175WMKCFBZ"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&gtag("event","search",{search_term:this.value})}),"undefined"!=typeof location$&&location$.subscribe(function(e){gtag("config","G-175WMKCFBZ",{page_path:e.pathname})})})</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-175WMKCFBZ"></script>
</head>
<body data-md-color-accent="none" data-md-color-primary="none" data-md-color-scheme="" dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#advanced-selectors">
          Skip to content
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header" data-md-component="header">
<nav aria-label="Header" class="md-header__inner md-grid">
<a aria-label="Tracetest" class="md-header__button md-logo" data-md-component="logo" href=".." title="Tracetest">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"></path></svg>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            Tracetest
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              Selectors
            
          </span>
</div>
</div>
</div>
<div class="md-header__source">
<a class="md-source" data-md-component="source" href="https://github.com/kubeshop/tracetest" title="Go to repository">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"></path></svg>
</div>
<div class="md-source__repository">
    kubeshop/tracetest
  </div>
</a>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navigation" class="md-nav md-nav--primary" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="Tracetest" class="md-nav__button md-logo" data-md-component="logo" href=".." title="Tracetest">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"></path></svg>
</a>
    Tracetest
  </label>
<div class="md-nav__source">
<a class="md-source" data-md-component="source" href="https://github.com/kubeshop/tracetest" title="Go to repository">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"></path></svg>
</div>
<div class="md-source__repository">
    kubeshop/tracetest
  </div>
</a>
</div>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="..">
        Welcome
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../installing/">
        Installation
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../getting-started/">
        Getting Started
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../architecture/">
        Architecture
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../create-test/">
        Creating Tests
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../adding-assertions/">
        Adding Assertions
      </a>
</li>
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" data-md-toggle="toc" id="__toc" type="checkbox"/>
<a class="md-nav__link md-nav__link--active" href="./">
        Selectors
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../openapi/">
        OpenAPI Definition
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../development/">
        Development
      </a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<a class="md-content__button md-icon" href="https://github.com/kubeshop/tracetest/blob/main/docs/advanced-selectors.md" title="Edit this page">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"></path></svg>
</a>
<h1 id="advanced-selectors">Advanced Selectors</h1>
<p>If you find yourself in a position where you cannot select complex spans, you can use our advanced selectors to help in that task. It enables you selecting spans that are impossible to select using just basic selectors.</p>
<p>In order to present each selector feature as easily as possible, we will use a theoretical scenario of an e-commerce application.</p>
<p>The system we will inspect has this flow:</p>
<div class="highlight"><pre><span></span><code>flowchart LR
    start((start))
    subgraph purchase
        cart-api
        purchase-api
    end
    subgraph auth
        auth-api
        auth-storage[(db)]
    end
    subgraph product
        product-api
        product-storage[(db)]
    end
    subgraph notification
        notification-api
        kafka{{kafka}}
        external-notification-service{{external service}}
    end

    start --&gt;|1. Close order| cart-api
    cart-api--&gt;|5. send buy action| purchase-api
    purchase-api --&gt; |7. Send notification to user|notification-api
    purchase-api --&gt;|6. can product be bought by user?| auth-api 
    auth-api --&gt; auth-storage
    cart-api --&gt;|2. is product available?| product-api
    product-api --&gt;|4. can user view product?| auth-api
    product-api --&gt;|3. retrieve product| product-storage

    notification-api --&gt;|8| kafka
    kafka --&gt;|9| external-notification-service
</code></pre></div>
<p>And it generates the following trace:</p>
<div class="highlight"><pre><span></span><code>flowchart TD
    A[" id: 1
        close order

        attributes:
        service.name: cart-api
        tracetest.span.type: http
        http.method: POST
    "]
    B[" id: 2
        is product available

        attributes:
        service.name: product-api
        tracetest.span.type: http
        http.method: GET
    "]
    C[" id: 3
        get product information

        attributes:
        service.name: product-api
        tracetest.span.type: db
        db.statement: SELECT * FROM ...
    "]
    D[" id: 4
        get user can access

        attributes:
        service.name: auth-api
        tracetest.span.type: http
        http.method: GET
    "]
    E[" id: 5
        get user auth information

        attributes:
        service.name: auth-api
        tracetest.span.type: db
        db.statement: SELECT * FROM ...
    "]
    F[" id: 6
        purchase products

        attributes:
        service.name: cart-api
        tracetest.span.type: http
        http.method: POST
    "]
    G[" id: 7
        get user can access

        attributes:
        service.name: auth-api
        tracetest.span.type: http
        http.method: GET
    "]
    H[" id: 8
        get user auth information

        attributes:
        service.name: auth-api
        tracetest.span.type: db
        db.statement: SELECT * FROM ...
    "]
    I[" id: 9
        notify user

        attributes:
        service.name: notification-api
        tracetest.span.type: http
        http.method: POST
    "]
    J[" id: 10
        send message to kafka

        attributes:
        service.name: notification-api
        tracetest.span.type: messaging
    "]
    K[" id: 10
        send message to users

        attributes:
        service.name: external-service
        tracetest.span.type: messaging
    "]


    A --&gt;|1| B
    B --&gt;|2| C
    B --&gt;|3| D
    D --&gt;|4| E
    A --&gt;|5| F
    F --&gt;|6| G
    G --&gt;|7| H
    F --&gt;|8| I
    I --&gt;|9| J
    J --&gt;|10| K
</code></pre></div>
<h1 id="features">Features</h1>
<h2 id="empty-selector">Empty selector</h2>
<p>By providing an empty selector, all spans from the trace are selected. Note that an empty selector is an empty string. Providing <code>span</code> or <code>span[]</code> as a selector will result as a syntax error.</p>
<h2 id="filter-by-attributes">Filter by attributes</h2>
<p>The most basic way of filtering the spans you want to apply an assertion on is by using its attributes. A good starting example would be filtering all spans of type <code>http</code>:</p>
<div class="highlight"><pre><span></span><code><span class="nt">span</span><span class="o">[</span><span class="nt">tracetest</span><span class="p">.</span><span class="nc">span</span><span class="p">.</span><span class="nc">type</span><span class="o">=</span><span class="s2">"http"</span><span class="o">]</span><span class="w"></span>
</code></pre></div>
<p>This would select the following spans:</p>
<div class="highlight"><pre><span></span><code>flowchart TD
    A[" id: 1
        close order

        attributes:
        service.name: cart-api
        tracetest.span.type: http
        http.method: POST
    "]
    B[" id: 2
        is product available

        attributes:
        service.name: product-api
        tracetest.span.type: http
        http.method: GET
    "]
    C[" id: 3
        get product information

        attributes:
        service.name: product-api
        tracetest.span.type: db
        db.statement: SELECT * FROM ...
    "]
    D[" id: 4
        get user can access

        attributes:
        service.name: auth-api
        tracetest.span.type: http
        http.method: GET
    "]
    E[" id: 5
        get user auth information

        attributes:
        service.name: auth-api
        tracetest.span.type: db
        db.statement: SELECT * FROM ...
    "]
    F[" id: 6
        purchase products

        attributes:
        service.name: cart-api
        tracetest.span.type: http
        http.method: POST
    "]
    G[" id: 7
        get user can access

        attributes:
        service.name: auth-api
        tracetest.span.type: http
        http.method: GET
    "]
    H[" id: 8
        get user auth information

        attributes:
        service.name: auth-api
        tracetest.span.type: db
        db.statement: SELECT * FROM ...
    "]
    I[" id: 9
        notify user

        attributes:
        service.name: notification-api
        tracetest.span.type: http
        http.method: POST
    "]
    J[" id: 10
        send message to kafka

        attributes:
        service.name: notification-api
        tracetest.span.type: messaging
    "]
    K[" id: 10
        send message to users

        attributes:
        service.name: external-service
        tracetest.span.type: messaging
    "]


    A --&gt;|1| B
    B --&gt;|2| C
    B --&gt;|3| D
    D --&gt;|4| E
    A --&gt;|5| F
    F --&gt;|6| G
    G --&gt;|7| H
    F --&gt;|8| I
    I --&gt;|9| J
    J --&gt;|10| K

    A:::selectedSpan
    B:::selectedSpan
    D:::selectedSpan
    F:::selectedSpan
    G:::selectedSpan
    I:::selectedSpan

    classDef selectedSpan fill:#439846, color:#ffffff
    classDef candidateSpan fill:#FF6905, color:#ffffff
</code></pre></div>
<h3 id="and-condition">AND condition</h3>
<p>If you need to narrow down your results, you can provide multiple properties in the selector by separating them usign a space. So, let's say we want all <code>http</code> spans <strong>AND</strong> were created by the service <code>cart-api</code>:</p>
<div class="highlight"><pre><span></span><code><span class="nt">span</span><span class="o">[</span><span class="nt">tracetest</span><span class="p">.</span><span class="nc">span</span><span class="p">.</span><span class="nc">type</span><span class="o">=</span><span class="s2">"http"</span><span class="w"> </span><span class="nt">service</span><span class="p">.</span><span class="nc">name</span><span class="o">=</span><span class="s2">"cart-api"</span><span class="o">]</span><span class="w"></span>
</code></pre></div>
<p>This would select the following spans:</p>
<div class="highlight"><pre><span></span><code>flowchart TD
    A[" id: 1
        close order

        attributes:
        service.name: cart-api
        tracetest.span.type: http
        http.method: POST
    "]
    B[" id: 2
        is product available

        attributes:
        service.name: product-api
        tracetest.span.type: http
        http.method: GET
    "]
    C[" id: 3
        get product information

        attributes:
        service.name: product-api
        tracetest.span.type: db
        db.statement: SELECT * FROM ...
    "]
    D[" id: 4
        get user can access

        attributes:
        service.name: auth-api
        tracetest.span.type: http
        http.method: GET
    "]
    E[" id: 5
        get user auth information

        attributes:
        service.name: auth-api
        tracetest.span.type: db
        db.statement: SELECT * FROM ...
    "]
    F[" id: 6
        purchase products

        attributes:
        service.name: cart-api
        tracetest.span.type: http
        http.method: POST
    "]
    G[" id: 7
        get user can access

        attributes:
        service.name: auth-api
        tracetest.span.type: http
        http.method: GET
    "]
    H[" id: 8
        get user auth information

        attributes:
        service.name: auth-api
        tracetest.span.type: db
        db.statement: SELECT * FROM ...
    "]
    I[" id: 9
        notify user

        attributes:
        service.name: notification-api
        tracetest.span.type: http
        http.method: POST
    "]
    J[" id: 10
        send message to kafka

        attributes:
        service.name: notification-api
        tracetest.span.type: messaging
    "]
    K[" id: 10
        send message to users

        attributes:
        service.name: external-service
        tracetest.span.type: messaging
    "]


    A --&gt;|1| B
    B --&gt;|2| C
    B --&gt;|3| D
    D --&gt;|4| E
    A --&gt;|5| F
    F --&gt;|6| G
    G --&gt;|7| H
    F --&gt;|8| I
    I --&gt;|9| J
    J --&gt;|10| K

    A:::selectedSpan
    F:::selectedSpan

    classDef selectedSpan fill:#439846, color:#ffffff
    classDef candidateSpan fill:#FF6905, color:#ffffff
</code></pre></div>
<h3 id="or-condition">OR condition</h3>
<p>Sometimes we want to have a broader result by selecting spans that match different selectors. Let's say we have to get all spans from our services, but not from any other external service.</p>
<div class="highlight"><pre><span></span><code><span class="nt">span</span><span class="o">[</span><span class="nt">service</span><span class="p">.</span><span class="nc">name</span><span class="o">=</span><span class="s2">"api-product"</span><span class="o">],</span><span class="w"> </span><span class="nt">span</span><span class="o">[</span><span class="nt">service</span><span class="p">.</span><span class="nc">name</span><span class="o">=</span><span class="s2">"api-auth"</span><span class="o">],</span><span class="w"> </span><span class="nt">span</span><span class="o">[</span><span class="nt">service</span><span class="p">.</span><span class="nc">name</span><span class="o">=</span><span class="s2">"api-notification"</span><span class="o">],</span><span class="w"> </span><span class="nt">span</span><span class="o">[</span><span class="nt">service</span><span class="p">.</span><span class="nc">name</span><span class="o">=</span><span class="s2">"api-cart"</span><span class="o">]</span><span class="w"></span>
</code></pre></div>
<p>This would select the following spans:</p>
<div class="highlight"><pre><span></span><code>flowchart TD
    A[" id: 1
        close order

        attributes:
        service.name: cart-api
        tracetest.span.type: http
        http.method: POST
    "]
    B[" id: 2
        is product available

        attributes:
        service.name: product-api
        tracetest.span.type: http
        http.method: GET
    "]
    C[" id: 3
        get product information

        attributes:
        service.name: product-api
        tracetest.span.type: db
        db.statement: SELECT * FROM ...
    "]
    D[" id: 4
        get user can access

        attributes:
        service.name: auth-api
        tracetest.span.type: http
        http.method: GET
    "]
    E[" id: 5
        get user auth information

        attributes:
        service.name: auth-api
        tracetest.span.type: db
        db.statement: SELECT * FROM ...
    "]
    F[" id: 6
        purchase products

        attributes:
        service.name: cart-api
        tracetest.span.type: http
        http.method: POST
    "]
    G[" id: 7
        get user can access

        attributes:
        service.name: auth-api
        tracetest.span.type: http
        http.method: GET
    "]
    H[" id: 8
        get user auth information

        attributes:
        service.name: auth-api
        tracetest.span.type: db
        db.statement: SELECT * FROM ...
    "]
    I[" id: 9
        notify user

        attributes:
        service.name: notification-api
        tracetest.span.type: http
        http.method: POST
    "]
    J[" id: 10
        send message to kafka

        attributes:
        service.name: notification-api
        tracetest.span.type: messaging
    "]
    K[" id: 10
        send message to users

        attributes:
        service.name: external-service
        tracetest.span.type: messaging
    "]


    A --&gt;|1| B
    B --&gt;|2| C
    B --&gt;|3| D
    D --&gt;|4| E
    A --&gt;|5| F
    F --&gt;|6| G
    G --&gt;|7| H
    F --&gt;|8| I
    I --&gt;|9| J
    J --&gt;|10| K

    A:::selectedSpan
    B:::selectedSpan
    C:::selectedSpan
    D:::selectedSpan
    E:::selectedSpan
    F:::selectedSpan
    G:::selectedSpan
    H:::selectedSpan
    I:::selectedSpan
    J:::selectedSpan

    classDef selectedSpan fill:#439846, color:#ffffff
    classDef candidateSpan fill:#FF6905, color:#ffffff
</code></pre></div>
<p>Each span selector will be executed individually and the results will be merged together, creating a list of all spans that match any of the provided span selectors.</p>
<h3 id="contains-operator">Contains operator</h3>
<p>Although it is possible to filter several span selectors at once to get a broader result, it might become verbose very quickly. The previous example can be written in another way to reduce its complexity:</p>
<div class="highlight"><pre><span></span><code><span class="nt">span</span><span class="o">[</span><span class="nt">service</span><span class="p">.</span><span class="nc">name</span><span class="w"> </span><span class="nt">contains</span><span class="w"> </span><span class="s2">"api"</span><span class="o">]</span><span class="w"></span>
</code></pre></div>
<p>This would select the same spans as the previous example:</p>
<div class="highlight"><pre><span></span><code>flowchart TD
    A[" id: 1
        close order

        attributes:
        service.name: cart-api
        tracetest.span.type: http
        http.method: POST
    "]
    B[" id: 2
        is product available

        attributes:
        service.name: product-api
        tracetest.span.type: http
        http.method: GET
    "]
    C[" id: 3
        get product information

        attributes:
        service.name: product-api
        tracetest.span.type: db
        db.statement: SELECT * FROM ...
    "]
    D[" id: 4
        get user can access

        attributes:
        service.name: auth-api
        tracetest.span.type: http
        http.method: GET
    "]
    E[" id: 5
        get user auth information

        attributes:
        service.name: auth-api
        tracetest.span.type: db
        db.statement: SELECT * FROM ...
    "]
    F[" id: 6
        purchase products

        attributes:
        service.name: cart-api
        tracetest.span.type: http
        http.method: POST
    "]
    G[" id: 7
        get user can access

        attributes:
        service.name: auth-api
        tracetest.span.type: http
        http.method: GET
    "]
    H[" id: 8
        get user auth information

        attributes:
        service.name: auth-api
        tracetest.span.type: db
        db.statement: SELECT * FROM ...
    "]
    I[" id: 9
        notify user

        attributes:
        service.name: notification-api
        tracetest.span.type: http
        http.method: POST
    "]
    J[" id: 10
        send message to kafka

        attributes:
        service.name: notification-api
        tracetest.span.type: messaging
    "]
    K[" id: 10
        send message to users

        attributes:
        service.name: external-service
        tracetest.span.type: messaging
    "]


    A --&gt;|1| B
    B --&gt;|2| C
    B --&gt;|3| D
    D --&gt;|4| E
    A --&gt;|5| F
    F --&gt;|6| G
    G --&gt;|7| H
    F --&gt;|8| I
    I --&gt;|9| J
    J --&gt;|10| K

    A:::selectedSpan
    B:::selectedSpan
    C:::selectedSpan
    D:::selectedSpan
    E:::selectedSpan
    F:::selectedSpan
    G:::selectedSpan
    H:::selectedSpan
    I:::selectedSpan
    J:::selectedSpan

    classDef selectedSpan fill:#439846, color:#ffffff
    classDef candidateSpan fill:#FF6905, color:#ffffff
</code></pre></div>
<h2 id="pseudo-classes-support">pseudo-classes support</h2>
<p>Sometimes filtering by attributes is not enough because we might have two or three identical spans in the tree, but we only want to assert one of them. For example, imagine a system that has a <code>retry</code> policy for all the HTTP requests it sends. How would we allow a user to validate if the <code>third</code> execution was successful without asserting the other two spans?</p>
<p>This is where pseudo-classes enter the scene. Those are ways of filtering spans by data that is not present in the span itself. For example, the order which the span appears.</p>
<blockquote>
<p>:warning: Today we support only <code>first</code>, <code>last</code>, and <code>nth_child</code>. If you think we should implement another one, please open an issue and explain why it is important and how it should behave.</p>
</blockquote>
<p>For the examples of the three pseudo-classes, let's consider we want to select a specific <code>http</code> span based on when it happens.</p>
<div class="highlight"><pre><span></span><code><span class="nt">span</span><span class="o">[</span><span class="nt">tracetest</span><span class="p">.</span><span class="nc">span</span><span class="p">.</span><span class="nc">type</span><span class="o">=</span><span class="s2">"http"</span><span class="o">]</span><span class="w"></span>
</code></pre></div>
<p>This will select the following spans:</p>
<div class="highlight"><pre><span></span><code>flowchart TD
    A[" id: 1
        close order

        attributes:
        service.name: cart-api
        tracetest.span.type: http
        http.method: POST
    "]
    B[" id: 2
        is product available

        attributes:
        service.name: product-api
        tracetest.span.type: http
        http.method: GET
    "]
    C[" id: 3
        get product information

        attributes:
        service.name: product-api
        tracetest.span.type: db
        db.statement: SELECT * FROM ...
    "]
    D[" id: 4
        get user can access

        attributes:
        service.name: auth-api
        tracetest.span.type: http
        http.method: GET
    "]
    E[" id: 5
        get user auth information

        attributes:
        service.name: auth-api
        tracetest.span.type: db
        db.statement: SELECT * FROM ...
    "]
    F[" id: 6
        purchase products

        attributes:
        service.name: cart-api
        tracetest.span.type: http
        http.method: POST
    "]
    G[" id: 7
        get user can access

        attributes:
        service.name: auth-api
        tracetest.span.type: http
        http.method: GET
    "]
    H[" id: 8
        get user auth information

        attributes:
        service.name: auth-api
        tracetest.span.type: db
        db.statement: SELECT * FROM ...
    "]
    I[" id: 9
        notify user

        attributes:
        service.name: notification-api
        tracetest.span.type: http
        http.method: POST
    "]
    J[" id: 10
        send message to kafka

        attributes:
        service.name: notification-api
        tracetest.span.type: messaging
    "]
    K[" id: 10
        send message to users

        attributes:
        service.name: external-service
        tracetest.span.type: messaging
    "]


    A --&gt;|1| B
    B --&gt;|2| C
    B --&gt;|3| D
    D --&gt;|4| E
    A --&gt;|5| F
    F --&gt;|6| G
    G --&gt;|7| H
    F --&gt;|8| I
    I --&gt;|9| J
    J --&gt;|10| K

    A:::selectedSpan
    B:::selectedSpan
    D:::selectedSpan
    F:::selectedSpan
    G:::selectedSpan
    I:::selectedSpan

    classDef selectedSpan fill:#439846, color:#ffffff
    classDef candidateSpan fill:#FF6905, color:#ffffff
</code></pre></div>
<h3 id="first">:first</h3>
<p>This would return the first appearing span from the list</p>
<div class="highlight"><pre><span></span><code><span class="nt">span</span><span class="o">[</span><span class="nt">tracetest</span><span class="p">.</span><span class="nc">span</span><span class="p">.</span><span class="nc">type</span><span class="o">=</span><span class="s2">"http"</span><span class="o">]</span><span class="p">:</span><span class="nd">first</span><span class="w"></span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>flowchart TD
    A[" id: 1
        close order

        attributes:
        service.name: cart-api
        tracetest.span.type: http
        http.method: POST
    "]
    B[" id: 2
        is product available

        attributes:
        service.name: product-api
        tracetest.span.type: http
        http.method: GET
    "]
    C[" id: 3
        get product information

        attributes:
        service.name: product-api
        tracetest.span.type: db
        db.statement: SELECT * FROM ...
    "]
    D[" id: 4
        get user can access

        attributes:
        service.name: auth-api
        tracetest.span.type: http
        http.method: GET
    "]
    E[" id: 5
        get user auth information

        attributes:
        service.name: auth-api
        tracetest.span.type: db
        db.statement: SELECT * FROM ...
    "]
    F[" id: 6
        purchase products

        attributes:
        service.name: cart-api
        tracetest.span.type: http
        http.method: POST
    "]
    G[" id: 7
        get user can access

        attributes:
        service.name: auth-api
        tracetest.span.type: http
        http.method: GET
    "]
    H[" id: 8
        get user auth information

        attributes:
        service.name: auth-api
        tracetest.span.type: db
        db.statement: SELECT * FROM ...
    "]
    I[" id: 9
        notify user

        attributes:
        service.name: notification-api
        tracetest.span.type: http
        http.method: POST
    "]
    J[" id: 10
        send message to kafka

        attributes:
        service.name: notification-api
        tracetest.span.type: messaging
    "]
    K[" id: 10
        send message to users

        attributes:
        service.name: external-service
        tracetest.span.type: messaging
    "]


    A --&gt;|1| B
    B --&gt;|2| C
    B --&gt;|3| D
    D --&gt;|4| E
    A --&gt;|5| F
    F --&gt;|6| G
    G --&gt;|7| H
    F --&gt;|8| I
    I --&gt;|9| J
    J --&gt;|10| K

    A:::selectedSpan
    B:::candidateSpan
    D:::candidateSpan
    F:::candidateSpan
    G:::candidateSpan
    I:::candidateSpan

    classDef selectedSpan fill:#439846, color:#ffffff
    classDef candidateSpan fill:#FF6905, color:#ffffff
</code></pre></div>
<h3 id="last">:last</h3>
<p>This would return the last appearing span from the list</p>
<div class="highlight"><pre><span></span><code><span class="nt">span</span><span class="o">[</span><span class="nt">tracetest</span><span class="p">.</span><span class="nc">span</span><span class="p">.</span><span class="nc">type</span><span class="o">=</span><span class="s2">"http"</span><span class="o">]</span><span class="p">:</span><span class="nd">last</span><span class="w"></span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>flowchart TD
    A[" id: 1
        close order

        attributes:
        service.name: cart-api
        tracetest.span.type: http
        http.method: POST
    "]
    B[" id: 2
        is product available

        attributes:
        service.name: product-api
        tracetest.span.type: http
        http.method: GET
    "]
    C[" id: 3
        get product information

        attributes:
        service.name: product-api
        tracetest.span.type: db
        db.statement: SELECT * FROM ...
    "]
    D[" id: 4
        get user can access

        attributes:
        service.name: auth-api
        tracetest.span.type: http
        http.method: GET
    "]
    E[" id: 5
        get user auth information

        attributes:
        service.name: auth-api
        tracetest.span.type: db
        db.statement: SELECT * FROM ...
    "]
    F[" id: 6
        purchase products

        attributes:
        service.name: cart-api
        tracetest.span.type: http
        http.method: POST
    "]
    G[" id: 7
        get user can access

        attributes:
        service.name: auth-api
        tracetest.span.type: http
        http.method: GET
    "]
    H[" id: 8
        get user auth information

        attributes:
        service.name: auth-api
        tracetest.span.type: db
        db.statement: SELECT * FROM ...
    "]
    I[" id: 9
        notify user

        attributes:
        service.name: notification-api
        tracetest.span.type: http
        http.method: POST
    "]
    J[" id: 10
        send message to kafka

        attributes:
        service.name: notification-api
        tracetest.span.type: messaging
    "]
    K[" id: 10
        send message to users

        attributes:
        service.name: external-service
        tracetest.span.type: messaging
    "]


    A --&gt;|1| B
    B --&gt;|2| C
    B --&gt;|3| D
    D --&gt;|4| E
    A --&gt;|5| F
    F --&gt;|6| G
    G --&gt;|7| H
    F --&gt;|8| I
    I --&gt;|9| J
    J --&gt;|10| K

    A:::candidateSpan
    B:::candidateSpan
    D:::candidateSpan
    F:::candidateSpan
    G:::candidateSpan
    I:::selectedSpan

    classDef selectedSpan fill:#439846, color:#ffffff
    classDef candidateSpan fill:#FF6905, color:#ffffff
</code></pre></div>
<h3 id="nth_child">:nth_child</h3>
<p>This enables you to fetch any item from the list based on its index. <code>n</code> starts at 1 (first element) and ends at <code>length</code> (last element). Any invalid <code>n</code> value will return in an empty list of spans being returned</p>
<div class="highlight"><pre><span></span><code><span class="nt">span</span><span class="o">[</span><span class="nt">tracetest</span><span class="p">.</span><span class="nc">span</span><span class="p">.</span><span class="nc">type</span><span class="o">=</span><span class="s2">"http"</span><span class="o">]</span><span class="p">:</span><span class="nd">nth_child</span><span class="o">(</span><span class="nt">3</span><span class="o">)</span><span class="w"></span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>flowchart TD
    A[" id: 1
        close order

        attributes:
        service.name: cart-api
        tracetest.span.type: http
        http.method: POST
    "]
    B[" id: 2
        is product available

        attributes:
        service.name: product-api
        tracetest.span.type: http
        http.method: GET
    "]
    C[" id: 3
        get product information

        attributes:
        service.name: product-api
        tracetest.span.type: db
        db.statement: SELECT * FROM ...
    "]
    D[" id: 4
        get user can access

        attributes:
        service.name: auth-api
        tracetest.span.type: http
        http.method: GET
    "]
    E[" id: 5
        get user auth information

        attributes:
        service.name: auth-api
        tracetest.span.type: db
        db.statement: SELECT * FROM ...
    "]
    F[" id: 6
        purchase products

        attributes:
        service.name: cart-api
        tracetest.span.type: http
        http.method: POST
    "]
    G[" id: 7
        get user can access

        attributes:
        service.name: auth-api
        tracetest.span.type: http
        http.method: GET
    "]
    H[" id: 8
        get user auth information

        attributes:
        service.name: auth-api
        tracetest.span.type: db
        db.statement: SELECT * FROM ...
    "]
    I[" id: 9
        notify user

        attributes:
        service.name: notification-api
        tracetest.span.type: http
        http.method: POST
    "]
    J[" id: 10
        send message to kafka

        attributes:
        service.name: notification-api
        tracetest.span.type: messaging
    "]
    K[" id: 10
        send message to users

        attributes:
        service.name: external-service
        tracetest.span.type: messaging
    "]


    A --&gt;|1| B
    B --&gt;|2| C
    B --&gt;|3| D
    D --&gt;|4| E
    A --&gt;|5| F
    F --&gt;|6| G
    G --&gt;|7| H
    F --&gt;|8| I
    I --&gt;|9| J
    J --&gt;|10| K

    A:::candidateSpan
    B:::candidateSpan
    D:::selectedSpan
    F:::candidateSpan
    G:::candidateSpan
    I:::candidateSpan

    classDef selectedSpan fill:#439846, color:#ffffff
    classDef candidateSpan fill:#FF6905, color:#ffffff
</code></pre></div>
<h2 id="parent-child-relation-filtering">Parent-child relation filtering</h2>
<p>Even with all those capabilities, we might have problems with ambiguous selectors returning several spans when just a few were intended.</p>
<p>In our example, you can notice that <code>auth-api</code> is called twice from different parts of the trace. At first by <code>product-api</code> and later by <code>cart-api</code>.</p>
<p>What if I want to test if a product only available in US can be bought in UK? The product can be seen by the user, but it cannot be bought if the user is outside US. Certainly I cannot apply the same assertions on all <code>auth-api</code> spans, otherwise the test will not pass.</p>
<blockquote>
<p>:information_source: When you filter by parent-child relation, it matches spans recursively in all levels bellow the parent. This doesn't match only direct children of the parent, but all other spans in the sub-tree.</p>
</blockquote>
<p>For example:</p>
<div class="highlight"><pre><span></span><code><span class="nt">span</span><span class="o">[</span><span class="nt">service</span><span class="p">.</span><span class="nc">name</span><span class="o">=</span><span class="s2">"auth-api"</span><span class="w"> </span><span class="nt">tracetest</span><span class="p">.</span><span class="nc">span</span><span class="p">.</span><span class="nc">type</span><span class="o">=</span><span class="s2">"http"</span><span class="o">]</span><span class="w"></span>
</code></pre></div>
<p>Will return:
<div class="highlight"><pre><span></span><code>flowchart TD
    A[" id: 1
        close order

        attributes:
        service.name: cart-api
        tracetest.span.type: http
        http.method: POST
    "]
    B[" id: 2
        is product available

        attributes:
        service.name: product-api
        tracetest.span.type: http
        http.method: GET
    "]
    C[" id: 3
        get product information

        attributes:
        service.name: product-api
        tracetest.span.type: db
        db.statement: SELECT * FROM ...
    "]
    D[" id: 4
        get user can access

        attributes:
        service.name: auth-api
        tracetest.span.type: http
        http.method: GET
    "]
    E[" id: 5
        get user auth information

        attributes:
        service.name: auth-api
        tracetest.span.type: db
        db.statement: SELECT * FROM ...
    "]
    F[" id: 6
        purchase products

        attributes:
        service.name: cart-api
        tracetest.span.type: http
        http.method: POST
    "]
    G[" id: 7
        get user can access

        attributes:
        service.name: auth-api
        tracetest.span.type: http
        http.method: GET
    "]
    H[" id: 8
        get user auth information

        attributes:
        service.name: auth-api
        tracetest.span.type: db
        db.statement: SELECT * FROM ...
    "]
    I[" id: 9
        notify user

        attributes:
        service.name: notification-api
        tracetest.span.type: http
        http.method: POST
    "]
    J[" id: 10
        send message to kafka

        attributes:
        service.name: notification-api
        tracetest.span.type: messaging
    "]
    K[" id: 10
        send message to users

        attributes:
        service.name: external-service
        tracetest.span.type: messaging
    "]


    A --&gt;|1| B
    B --&gt;|2| C
    B --&gt;|3| D
    D --&gt;|4| E
    A --&gt;|5| F
    F --&gt;|6| G
    G --&gt;|7| H
    F --&gt;|8| I
    I --&gt;|9| J
    J --&gt;|10| K

    D:::selectedSpan
    G:::selectedSpan

    classDef selectedSpan fill:#439846, color:#ffffff
    classDef candidateSpan fill:#FF6905, color:#ffffff
</code></pre></div></p>
<p>This is a problem, because if we apply the same assertion to both spans, one of them will fail. We could try to use <code>nth_child</code> but that could break if a http request failed and the retry policy kicked in. Thus, the only way of filtering that is based on the context when it was generated. For example: using its parent span to do so.</p>
<p>We could use the <code>purchase products</code> parent to ensure just <code>http</code> class to the <code>auth-api</code> triggered by the <code>purchase-api</code> would be selected:</p>
<div class="highlight"><pre><span></span><code><span class="nt">span</span><span class="o">[</span><span class="nt">service</span><span class="p">.</span><span class="nc">name</span><span class="o">=</span><span class="s2">"cart-api"</span><span class="o">,</span><span class="w"> </span><span class="nt">name</span><span class="o">=</span><span class="s2">"purchase products"</span><span class="o">]</span><span class="w"> </span><span class="nt">span</span><span class="o">[</span><span class="nt">service</span><span class="p">.</span><span class="nc">name</span><span class="o">=</span><span class="s2">"auth-api"</span><span class="w"> </span><span class="nt">tracetest</span><span class="p">.</span><span class="nc">span</span><span class="p">.</span><span class="nc">type</span><span class="o">=</span><span class="s2">"http"</span><span class="o">]</span><span class="w"></span>
</code></pre></div>
<p>This would find the parent span and only select the spans that are descedents of that parent and match the provided filter:</p>
<div class="highlight"><pre><span></span><code>flowchart TD
    A[" id: 1
        close order

        attributes:
        service.name: cart-api
        tracetest.span.type: http
        http.method: POST
    "]
    B[" id: 2
        is product available

        attributes:
        service.name: product-api
        tracetest.span.type: http
        http.method: GET
    "]
    C[" id: 3
        get product information

        attributes:
        service.name: product-api
        tracetest.span.type: db
        db.statement: SELECT * FROM ...
    "]
    D[" id: 4
        get user can access

        attributes:
        service.name: auth-api
        tracetest.span.type: http
        http.method: GET
    "]
    E[" id: 5
        get user auth information

        attributes:
        service.name: auth-api
        tracetest.span.type: db
        db.statement: SELECT * FROM ...
    "]
    F[" id: 6
        purchase products

        attributes:
        service.name: cart-api
        tracetest.span.type: http
        http.method: POST
    "]
    G[" id: 7
        get user can access

        attributes:
        service.name: auth-api
        tracetest.span.type: http
        http.method: GET
    "]
    H[" id: 8
        get user auth information

        attributes:
        service.name: auth-api
        tracetest.span.type: db
        db.statement: SELECT * FROM ...
    "]
    I[" id: 9
        notify user

        attributes:
        service.name: notification-api
        tracetest.span.type: http
        http.method: POST
    "]
    J[" id: 10
        send message to kafka

        attributes:
        service.name: notification-api
        tracetest.span.type: messaging
    "]
    K[" id: 10
        send message to users

        attributes:
        service.name: external-service
        tracetest.span.type: messaging
    "]


    A --&gt;|1| B
    B --&gt;|2| C
    B --&gt;|3| D
    D --&gt;|4| E
    A --&gt;|5| F
    F --&gt;|6| G
    G --&gt;|7| H
    F --&gt;|8| I
    I --&gt;|9| J
    J --&gt;|10| K

    F:::parentSpan
    G:::selectedSpan

    classDef selectedSpan fill:#439846, color:#ffffff
    classDef parentSpan fill:#3792cb, color:#ffffff
</code></pre></div>
</article>
</div>
</div>
</main>
<footer class="md-footer">
<nav aria-label="Footer" class="md-footer__inner md-grid">
<a aria-label="Previous: Adding Assertions" class="md-footer__link md-footer__link--prev" href="../adding-assertions/" rel="prev">
<div class="md-footer__button md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"></path></svg>
</div>
<div class="md-footer__title">
<div class="md-ellipsis">
<span class="md-footer__direction">
                Previous
              </span>
              Adding Assertions
            </div>
</div>
</a>
<a aria-label="Next: OpenAPI Definition" class="md-footer__link md-footer__link--next" href="../openapi/" rel="next">
<div class="md-footer__title">
<div class="md-ellipsis">
<span class="md-footer__direction">
                Next
              </span>
              OpenAPI Definition
            </div>
</div>
<div class="md-footer__button md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"></path></svg>
</div>
</a>
</nav>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
<div class="md-copyright__highlight">
      Copyright © 2022 <a href="https://kubeshop.io">Kubeshop</a>
</div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "..", "features": ["navigation.expand"], "search": "../assets/javascripts/workers/search.2a1c317c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
<script src="../assets/javascripts/bundle.c2e1ee47.min.js"></script>
</body>
</html>